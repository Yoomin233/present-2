<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    div.scrollContainer {
      width: 80%;
      border: 1px solid #eee;
      padding: 30px 10px;
      height: 80%;
      overflow-y: scroll;
      overflow-x: hidden;
      position: absolute;
      margin: auto;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      font-size: 150%;
      box-sizing: border-box;
    }

    div.wadget {
      position: absolute;
    }

    div.wadget1 {
      top: 10vh;
      left: 5vw;
      width: 10vw;
      height: 10vw;
      border: 1px solid black;
      transition: opacity .5s linear, transform .4s cubic-bezier(0.15, 0.81, 0.27, 1.55);
      opacity: 0;
      transform: rotate(45deg);
    }

    div.wadget1.showed {
      opacity: 1;
      transform: none;
    }

    div.wadget2 {
      top: 10vh;
      right: 5vw;
      width: 10vw;
      height: 10vw;
      border: 1px solid black;
      transition: opacity .5s linear, transform .4s cubic-bezier(0.15, 0.81, 0.27, 1.55);
      opacity: 0;
      transform: rotate(45deg);
    }

    div.wadget2.showed {
      opacity: 1;
      transform: none;
    }
  </style>
</head>

<body>
  <div class="audioContainer">
    <!-- <audio src="/static/sounds/kenny_chesney_me_and_you.mp3" loop preload></audio> -->
  </div>
  <div class="scrollContainer">
  </div>
  <div class="wadget wadget1"></div>
  <div class="wadget wadget2"></div>

  <script>
    // const playedTime = location.search.match(/\d+/) ? location.search.match(/\d+/)[0] : 0
    // const audioElem = document.querySelector('audio')
    // audioElem.currentTime = playedTime
    // audioElem.play()
    const contentContainer = document.querySelector('.scrollContainer')
    const totalScrollable = contentContainer.scrollHeight - contentContainer.offsetHeight

    let touchingFlag = false
    function throttle(func, interval) {
      let now = Date.now()
      return (...args) => {
        if (Date.now() - now > interval) {
          now = Date.now()
          return func(...args)
        }
      }
    }
    function scrollMain() {
      const currentScrollTop = contentContainer.scrollTop
      if (contentContainer.scrollTop < totalScrollable) {
        !touchingFlag && (contentContainer.scrollTop += 1)
        setTimeout(scrollMain, 40)
      } else {
        setTimeout(scrollMain, 100)
      }
    }
    scrollMain()
    // contentContainer.addEventListener('mouseover', e => {
    //   touchingFlag = true
    // })
    contentContainer.addEventListener('mouseleave', e => {
      touchingFlag = false
    })
    contentContainer.addEventListener('mouseenter', e => {
      touchingFlag = true
    })
    contentContainer.addEventListener('touchstart', e => {
      touchingFlag = true
    })
    contentContainer.addEventListener('touchend', e => {
      touchingFlag = false
    })

    function toggleShowStatus({
      actions
    }) {
      return (direction, currentPosition) => {
        if (direction === 'down') {
          const latestMatchs = actions.filter(action => currentPosition > action.position)
          const latestMatch = latestMatchs[latestMatchs.length - 1]
          if (latestMatch) {
            latestMatch.element.classList.add(latestMatch.className)
          }
        } else if (direction === 'up') {
          const latestMatchs = actions.filter(action => currentPosition < action.position)
          const latestMatch = latestMatchs[0]
          if (latestMatch) {
            latestMatch.element.classList.remove(latestMatch.className)
          }
        }
      }
    }
    const wrappedToggleShowStatus = toggleShowStatus({
      actions: [{
        element: document.querySelector('div.wadget1'),
        position: 0.2,
        className: 'showed'
      }, {
        element: document.querySelector('div.wadget2'),
        position: 0.4,
        className: 'showed'
      }]
    })

    let latestScrollTop = 0
    contentContainer.addEventListener('scroll', throttle((e) => {
      const currentScrollTop = contentContainer.scrollTop
      // 向下滚动
      if (currentScrollTop > latestScrollTop) {
        wrappedToggleShowStatus('down', currentScrollTop / totalScrollable)
      } else {
        wrappedToggleShowStatus('up', currentScrollTop / totalScrollable)
      }
      latestScrollTop = currentScrollTop
    }, 50))
  </script>
</body>

</html>